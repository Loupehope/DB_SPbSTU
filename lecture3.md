- [Лекция 1](#1-Лекция)
  - Старый курс

- [Лекция 2](#2-Лекция)
	- [Кумулятивные статистики](#Кумулятивные-статистики)
	- [DB Time](#DB-Time)
	- [Free buffer waits](#Free-buffer-waits)
	- [Buffer busy waits](#Buffer-busy-waits)

- [Лекция 3](#3-Лекция)
	- [Baselines](#Baselines)
	- [DBMS_WORKLOAD_REPOSITORY](#DBMS_WORKLOAD_REPOSITORY)

- [Лекция 4](#4-Лекция)
	- Ничего полезного

- [Лекция 5](#5-Лекция)
	- [Метрика](#Метрика)
	- [Baseline](#Baseline)

- [Лекция 6](#6-Лекция)
	- [SYSTEM_MOVING_WINDOW](#SYSTEM_MOVING_WINDOW)
	- [Шаблоны опорных линий](#Шаблоны-опорных-линий)

- [Лекция 7](#7-Лекция)
	- [DEFAULT_MAINTANENCE_PLAN](#DEFAULT_MAINTANENCE_PLAN)
	- [Autotask Background Process](#Autotask-Background-Process)
	- [Active Session History](#Active-Session-History)
	- [Доступ к ASH](#Доступ-к-ASH)

- [Лекция 8](#8-Лекция)

# 1 Лекция
- [1 часть](https://github.com/Loupehope/DB_SPbSTU/blob/master/lecture.md#%D0%BF%D0%B5%D1%80%D0%B2%D0%B0%D1%8F-%D0%BB%D0%B5%D0%BA%D1%86%D0%B8%D1%8F)
- [2 часть](https://github.com/Loupehope/DB_SPbSTU/blob/master/lecture.md#%D0%B2%D1%82%D0%BE%D1%80%D0%B0%D1%8F-%D0%BB%D0%B5%D0%BA%D1%86%D0%B8%D1%8F)

# 2 Лекция
**Кумулятивные статистики** - суммарные данные о количестве и производительности событий, которые прошли в БД с момента старта экземпляра:
- события ожидания (wait events) - инфа о сессиях, которые были вынуждены ожидать или в данный момент ожидают по различным причинам
- временная модель - набор статистик, которые представляют процент от времени БД для каждого типа событий

**Метрики**: кол-во произошедших в единицу времени событий (транзакция, секунда)

**Выборочные статистики** - хранятся после перезапуска экземпляра - на сессию, на SQL, службы

**Цели настройки**:
- Minimising response time
- Increasing throughput
- Increasing load capabilities
- Decreasing recovery time

**DB Time** - количество времени в миллисекундах, затраченное БД на выполнение пользовательских запросов (не включаются фоновые запросы, не простаивающие пользовательские сессии). Изменяется суммарно с момента запуска экземпляра.

**Free buffer waits** - время ожидания свободных буфферов в ОЗУ (DBWR), чтобы серверный процесс мог туда записать новый блок из файловой системы.

**Buffer busy waits** - сессия хочет получить доступ к блоку базы данных Buffer Cache (DBWR) - но не может, тк буффер занят сейчас - кто-то его уже изменяет

**enq: TX - index contention** - ожидание, связанное с работой индекса - ТХ - блокировка таблицы на уровне строк 

**Log file sync** - ожидание, связанна с Log Writer - перегружен и не успевает всё записать redo log файлы 

**db file sequential read** - ожидание, связанное с чтением данных из файла - серверный процесс пытается читать информацию из файла, но I/O слишком медленный

**DB Time** = DB wait time (нужна настройка экземпляра) + DB CPU time (нужна настройка SQL команд)

Time Model:
- V$SYS_TIME_MODEL
- V$SESS_TIME_MODEL

Динамические представления - предоставляют информацию об изменении состояния и условий в экземпляре (Доступ Sys, select_catalog_row) (ОЗУ)

Уровни статистики V&STATISTICS_LEVEL:
- Basic - автоматически статистики не собираются
- Typical - данные для статистики собираются на уровне сегментов
- All - дом статистики собираются из ОС

Системные статистики:
- V$STATNAME - названия статистик
- V$SYSSTAT - для SYS
- V$SESSTAT - статистики для всех сессий
- V$MYSTAT - статистики для текущей сессии
- V$SERVICESTAT - для служб

Классы ожиданий:
- V$SESSION_WAIT_CLASS
- V$SYSTEM_WAIT_CLASS
- V$SERVICE_WAIT_CLASS
- V$EVENT_NAME

- V$SESSION_WAIT - события и ресурсы, которые ожидает сессия

# 3 Лекция
Снепшоты хранятся в SYSAUX.
Baselines - опорные линии - снепшоты, когда БД работает нормально.

**DBMS_WORKLOAD_REPOSITORY** - для работы со снепшотами:
- Период хранения Retention указывается в минутах. По умолчанию – 8 дней. Минимальное значение – 1 день. При значении 0 автоматическая очистка отключается.
- Параметр Interval определяет интервал между снимками. Минимальное значение – 10 минут. Максимальное значение -100 лет. Значение по умолчанию – 60 минут.
- Параметр Topnsql – количество команд SQL, для которых необходимо собирать данные о производительности. Default - top 30.

Остальная лекция - скрины из EM.

# 4 Лекция

Ничего полезного - общие советы по поиску проблем в БД.

# 5 Лекция

- **Метрика** - скорость изменения кумулятивной статистики.
- **Alert** - событие, генерируемое при пересечении наблюдемой метрики порога.
- **Baseline** - данные (набор снимков), собираемые из нормально работающей БД для сравнения производительности.

# 6 Лекция

Поддерживается одна опорная линия с подвижным окном:
- **SYSTEM_MOVING_WINDOW** - опорная линия с подвижным окном, которое соответствует последним 8 дням данных в автоматическом репозитории нагрузки.
- Создается автоматически в Oracle 11g.

**Шаблоны опорных линий** - позволяют состявлять расписание создания опорных линий для периодов времени в будущем:
- Для одного периода времени в будущем
- Повторяющееся расписание
- Когда конечное время для шаблона опорной линии изменится с будущего на прошедшее, процесс MMON обнаружит изменение и создаст опорную линию.

**Три метода сравнения метрик опорных линий**:
- Доля необычных значений по сравнению с данными опорной линии - пороги уровня значимости
- Значение близкое или превышающее пиковое значение по данным опорной линии - порого в процентах от максимума
- Величины порогов, основанные на фиксированных значениях - устанавливаются DBA

# 7 Лекция

Задачи автоматического обслуживания помогают:
- контролировать использование памяти;
- собирать статистики оптимизации;
- настраивать высоконагруженные команды SQL.

Выполнение задач приоритезировано:
- если задачи не имеют достаточного времени или ресурсов для завершения работы, то они перенаправляются в след. окно.
- когда задачи заполняют доступные окна, продолжительность и распределение ресурсов может потребоваться изменить.

Задачи автоматизации сопоставлены определенным окнам. Все дневные окна по умолчанию принадлежа Maintenance Window Group.

Когда окно обслуживания открывается, диспетчер ресурсов автоматически устанавливает **DEFAULT_MAINTANENCE_PLAN** для контроля ресурсов CPU, используемых задачами авотматизации обслуживания.

Для того, чтобы иметь возможность давать различные приоритеты каждой задаче во время окна обслуживания, с DEFAULT_MAINTENANCE_PLAN сопоставлены различные группы потребителей:
- **ORA$AUTOTASK_SUB_PLAN** -> **ORA$AUTOTASK_HIGH_URGENT_PLAN - наивысший приоритет**, ORA$AUTOTASK_HIGH_SUB_PLAN, ORA$AUTOTASK_HIGH_MEDIUM_PLAN.

**Autotask Background Process** (ABP) - функционирует как посредник между задачами автоматизации и Scheduler:
- Его главная задача - преобразовать задачи автоматизации в работы Autotask для выполнения Scheduler'ом.
- Обслуживает также историю выполнения всех задач и сохраняет их в частный репозиторий в табличном пространстве SYSAUX (можно посмотреть через DBA_AUTOTASK_TASK).
- Запускается процессом MMON при старте окна обслуживания.
- Существует только один процесс ABP для всех экземпляров.

**ADDM - диагностическое ПО, встроенное в Oracle**:
- Проверяет и анализирует информацию, помещенную в AWR с целью определения возможных проблем с производительностью.
- Сервер Oracle автоматически забирает статистику из SGA каждые 60 мин и сохраняет её в AWR в форме снимков (снепшотов).
- ADDM запускется MMON'ом для каждого экземпляра.
- Каждый раз при получении снимка ADDM запускается для выполнения анализа на интервале между двумя последними снимками. Такой подход позволяет предварительно контролировать экземпляр и определять узкие места.
- Результаты анализа ADDM сохраняются в AWR.

**ADDM использует DB time для определения**:
- компонентов базы данных, которые требуют анализа
- узких мест производительности

ADDM проверяет затраченное DB time в двух независимых направлениях:
- Первая размерность - DB time - при пользовательских запросах (подключение к БД, выполнение SQL команд)
- Вторая размерность - DB time - при использовании или ожидании ресурсов для выполнения пользовательских команд.

**Active Session History** - хранит историю в течение DB time:
- извлекает только выборки информации из V$SESSION.
- построен как кользевой буффер в памяти и предшествующая информация перезаписывается, когда это необходимо.
- память для ASH берется в SGA и фиксируется для времени жизни экземпляра - 2 МБ памяти на CPU.
- ASH не может превысить максимальную границу в 5% от величины shared_pool_size или от SGA_TARGET.

**Доступ к ASH**:
- Dump a trace file
- V$Active_session_history
- DBA_HIST_ACTIVE_SESS_HISTORY
- ASH report
- EM

# 8 Лекция

**Служба** - это средство группирования сессий, которые выполняют один и тот же вид работы:
- обеспечивают одно-системное представление вместо многоэкземплярного представления
- представляет собой часть регулярных задач администрирования, которые обеспечивают динамическое выделение служб экземпляру
- является основой для высокой доступности соединений
- обеспечивает дополнительное измерение для настройки производительности

**Атрибуты службы**:
- Для службы с единственным экземпляром:
	- глобальное уникальное имя
	- сетевое имя
- Доп. атрибуты для большего кол-ва экземпляров:
	- цель настройки, характеристики отказоустойчивости и тд.

Типы служб:
- службы приложений
- внутренние службы:
	- SYS$BACKGROUND - используется только фоновыми процессами
	- SYS$USERS - служба по умолчанию для пользовательских сессий, не ассоциированных со службами
	- не могут быть удалены или изменены
- предел - 118 служб на БД:
	- 116 служб приложений
	- 2 внутренние службы

Создание служб:
- создаются автоматически при старте экземпляра на основе параметра инициализации SERVICE_NAMES
- сервисы обслуживаются в словаре данных

Возможности на уровне служб:
- словарь данных обслуживает службы
- AWR оценивает производительность служб
- DRM использует службы для установки приоритетов
