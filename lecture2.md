# Лекиия 11
# Flashback

- Flashback query - запросы к старому состоянию таблицы в каком-то моменте времени.  
- Flashback version query - как изменялись данные в определненный момент времени - не используется для внешних, временных, sys таблицами и представлениями. Не может захватить интервал при наличии DDL команды и сжатие сегмента.        
- Flashback transaction query - изменения выполненные за транзакцию - DDL - изменения в системных таблицах.  
- Flashback transaction - восстановление данных по транзакции с учетом и без учета зависимостей.   

1. Уровень БД (Flashback log - flashback recovery area)
	- Можно восстановить бд на конкретный момент времени
	- По умолчанию выключена, так как ресуросемкая
2. Уровень таблицы 
	- Drop - восстановление таблицы и данных (recycle bin)
	- Table - восстановление из undo 
	- Query - сравнение текущих данных и данных в прошлом из Undo
	- Version - из Undo
	- Data archive - получить исторические данные по транзакциям (Archive log)
3. Уровень транзакций - восстанавливает подозрительные транзакции и зависимые undo/redo archive log
# Recycle Bin
Recyclebin=ON; - не работает
Flashback table <name> to before drop.
BIN$ - приставка, данные переименовываются, но не перемещаются, DBA_FREE_SPACE - не изменяется.   

Данные хранятся, пока не удалим или хватает места на диске.   
В случае восстановления данных с одинаковым именем, т для восстановления можно использовать имена системы, иначе будет восстановлена последняя удаленная.    
При недостатке места, корзина будет расширяться, если это невозможно, то удаляются элементы корзины.   
Для очищения корзины можно выполнить команду purge:
1. Purge table|index
2. Purge Tablespace [user]
3. Purge user_recyclebin (мои объекты), dba_recyclebin (вся корзина).
Удаление минуя корзину:
1. Drop table <> purge
2. Drop tablespace <> including contents
3. Drop user <> cascade - удаление юзера вместе с его объектами
*can_undrop* - могут быть восстановлены.
*show recyclebin*.  

Для включения Flashback включить:
1. Undo_managment='Auto'
2. Undo_tablespace='UNDOTBS1' - активно в данный момент только одно
3. Undo_retention=900

Ретроспективный запрос.  

Logminer - для упрощения восстановления - определяет undo sql.     

Предустановки:
1. Иметь разрешение на выполнение пакета dbms_flashback
2. Дом легирование для первичного ключа
3. Select any transaction привелегия
4. Дополнительные журналы логирования 

Опции восстановления:
1. NoconflictOnly - неконфликтующие изменения целевой транзакции будут откатаны 
2. Nocascade force - все изменения в целевой транзакции будут откатаны
3. Cascade - будут откатаны изменения в зависимых и целевой транзакциях

Отчеты об откатах - dba_flashback_txn_state, dba_fkashback_txn_report.  

# Лекиия 12
# Flashback transaction

Осуществляется онлайн и требует:
1. Наличие прав Fkashback any table или наличии привилегии Flashback для конкретной таблицы.
2. Наличие привилегий select, insert, delete, alter - dml 
3. Включить row movement (alter table <name> enable row movement)

Ограничения:
1. Статистика не откатывается
2. Невозможно для системных таблиц, не включает ddl операции, не генерирует undo/redo
3. Поддерживаются текщие индексы и зависимости
4. Выполняется как единая транзакция с exclusive DML lock.

# Flashback database

Подготовительный этап:
1. SHUTDOWN IMMEDIATE;
2. STARTUP MOUNT EXCLUSIVE;
3. ALTER SYSTEM SET DB_FLASHBACK_RETENTION_TARGET=2880 SCOPE=BOTH;
4. ALTER DATABASE FLASHBACK ON;
5. ALTER DATABASE OPEN;

Когда не можем использовать Flashback database:
1. Контрольные файлы были восстановлены или заново созданы
2. Табличичное пространство было удалено
3. Файлы данных увеличились в размере
  
Гарантированная точка восстановления гарантирует, что вы можете выполнить
Команда FLASHBACK DATABASE на этот SCN в любое время.

# Лекиия 13
ASM - automatic storage management.  
Фоновые процессы на сторне ASM:
- RBAL - координирует балансировку активности для дисклвых групп
- ARB0 - Перемещают allocation unit между дисками ASM по 1, 2, 4, 8, 16, 64 мб обычно
- GMON - Group monitor - работает со спец системой встроенной таблицы, которая зранит инфу о стаусе дисковых групп

Фоновые процессы на сторне БД:
- RBAL - открыть диски в дисковых группах ASM
- ASMB - осуществляет подключение FG - "моста" к экземпляру ASM

Диски ASM объединяются в дисковые группы.   

Процесс создания ASM экземпляра:
- Создаем дисковую группу
- Какая избыточность (делать ли копии или нет)
- Выбираем разделы для включения в дисковую группу
- Есть скрипт local_config, который сконфигурирует кластерную систему
- Создастся файл параметров и файл паролей
- ASM_POWER_LIMIT - контролирует скорость перебалансировки (от 1 до 11 - max)
- ASM_DISKSTRING - список дисков
- ASM_DISKGROUPS - список группов дисков
- SPFILE - отдельный spfile+asm.ora  
Можно коннектится как sysasm или sysoper (может лишь остановить или запустить).   
Экземпляр не монтируем и не открываем.   
SYSASM - роль для обслуживания ASM экземпляров.
В ASM - нет словаря данных.
Для остановки необходимо - необходимо сначала отключить бд, а потом ASM. 
Структура:
- ASM файлы состоят из ASM дисковых групп, которые состоят из дисков, которые состоят из allocation unit, которые отображаются на физические блоки.
- ASM файлы - хранят инфу о файлах данных, контрольных файлах, spfiles.

Дисковая группа - набор дисков, который управляется, как одна логическая единица.   

Failure group:
- Группа ошибок - набор дисков, обеспечивающий дублирование информации - дисковую группу разделяют на группу дисков и данные в каждой группе дублируются. Теперь когда одна группа упадет, информация останется на других.

Зеркалирование - disk group mirroring:
- Зеркалирование осуществляется на уровне экстентов (1 или несколько allocation units)
- На каждом диске одновременно находятся исходные и зеркальные au
- Уровни избыточности (зеркалированности):
	- Внешняя избыточность - при помощи оборудования
	- Нормальная избыточность - два зеркала - по крайней мере две группы ошибок
	- Высока избыточность - как минимум 3 failure group
По умолчанию каждый диск это failure group.  
Динамическая перебалансировка - добавили/удалили дисковую группу - автоматически происходит перебалансировка данных - перемещается то количество даннх, которое пропорционально добавленному хранилищу.    
Скорость перебалансировки определяется параметров ASM_POWER_LIMIT (1 -> 11).   

Версии формата обмена между бд и ASM:
1. Версия бд должна быть больше, чем Compatible.RDBMS - формат сообщений между бд и ASM (минимальная версия для монтирования дисковой группы).
2. Версия asm должна быть больше, чем Compatible.ASM - формат хранения мета информации на ASM.
3. Полезно при работе с гетерогенными системами
4. Этот параметр нельзя отменить

Параметры:
- au_size - 1, 2, 4, 8, 16, 32, 64 mb
- Compatible.RDBMS
- Compatible.ASM
- disk_repair_time - 0 - 2^32 - время перед отключением диска при выключении
- template.redundancy - шаблон избыточности - unprotected|mirror|high
- template.stripe - расслоение данных - coarse (для перераспределения данных)|fine (распределение по 128 кб для файлов управления, redo logs)

Механизм быстрой перебалансировки - fast mirror resync - упал какой-то диск - переходим на другой - диск восстановился - скопировали на него только модифицированные экстенты.   
V$ASM_DISK and V$ASM_DISK_STAT - представления с информациях о дисках.

Ограничения ASM:
- 63 дисковых группы
- 10 000 дисков ASM
- 4 петабайта данных для каждого диска
- 40 экзабайт хранилища
- 1 миллион файлов

# Лекиия 14

Запуск RMAN:
`rmat target (целевая база) (имя пользователя/пароль@индетификатор бд)`, если больше ничего не указывать, то вся мета инфа о восстановлении будет сохранятся в файле управления.
log_archive_min_success_dest - минимальное возможное количество успешного архивирования.  
RUN - запуск пакетов (job).   
Бекапы могут быть сделаны на диске, ленточном устройстве (Media management library), FRA.   
Политика удежрания - сколько необходимо зранить резервные копии:
- Recovery window - пероид времени, в который восстановление доступно
- Redundancy - фиксированное число бекапов, которые должны храниться
REPORT OBSOLETE - отчет по устаревшим файлам.   
DELETE OBSOLETE - удаление устаревших копий.   

# Лекиия 15

Каталог восстановления содержит метаданные об операциях RMAN для каждой зарегистрированной целевой базы данных.

Rman + controlfile:
- Простота администрирования
- По умолчанию

Rman + recovery catalog:
- Копии controlfiles
- Может обслуживаться нексолько бд
- Сохранение скриптов
- Отчеты для таргетов
- Возможность хранить бекапы вечно

Метаданные: backup set list, image copy list
В Recovery catalog database хранится:
- Инфомрация о структуре бд
- Архивы журналов повторов
- Информация по Backup sets
- Информация по Data file copies

Dublicate database
Если сделали дубликат бд и пытаемся ее зарегистрировать в каталоге (clone), то будет ошибка, так как бд уже есть. В клоне не меняется id (dbid) не изменяется (dbid v$database). Чтобы изменить dbid утилита - dbnewid - `nid target=user/pass@svc_name [DBNAME=new_dbname]` - база должна быть в режиме mount.

Чтобы будет после смены:
- Предыдущие бекапы и логи недоступны
- Надо открыть бд с resetlogs
- Сделать копию бд

Unregister database - отвязать бд от каталога.

В каталог можно добавить:
- Копии controlfile
- Data file
- Backup
- Archived redo log.   

Пересинхронизация:
- Частичная: журналы повторов, backup sets, data file copies.
- Полная: частичная + структура бд (создается снепшот файла управления).   

Resync:
- Выполнение нечастых бекпов
- Изменена структура бд

Скрипты:
- Локальные - ассоциированы с конкретной бд (CREATE SCRIPT)
- Глобальные - работает с любой бд (CREATE GLOBAL SCRIPT).   

Резервное копирование каталога:
- На диск
- На ленточное устройство
- Копия файлов управления

Resync catalog (на основии файла управления) или catalog start with.   
Экспрот и импорт (export, import) - создаем логическое резервное копирование (набор команд для выполнения)

Virtual private catalog - кусок из основного каталога. (GRANT REGISTER [Catalog] DATABSE [NAME] TO user).   
`create virtual catalog;`.  

# Лекиия 16

Типы бекапов:
- Full: всё что есть в бд - файлы данных, control file + archive log и spfile [optional] + опция delete input - удаление archive log после копирования - работа не с fra - DISK.
- Incremental: только те изменения, которые были выполнены после последнего бекапа

Определить файлы для бекапа: вся бд, журналы повторов, control files, spfile.   
Image copy - bit to bit (только на диск копирование).  

Место бекапа:
- Диск
- Media Management Library - бекап если работаем с rman для ленточных устройств (или Oracle secure backup)
- FRA (файлы OMF, сами удаляются и управляются)

Параметры rman:
- Каналы - по которым идет запись
- Число backup copies
- Определение максимального размера и числа файла копии
- Оптимизиция
- Автоматическое копирование control file
- Определение параллелизма (sbt - serial backup tape - `PARALLELISM 3`)
- Установка параметров шифрования и компрессии (COMPRESSED - только backup set - удаление пустых экстентов + над HWM)
- Исключение табличного пространства из бекапа
- Device type 

Есть галочка в policy - автоматическое копирование файлов управления и spfile при каждом бекапе и изменении структуры бд.    

Опция CLEAR - установка параметра в значение по умолчанию.

show exclude - те табличные пространства, которые исключены из бекапов.   

Оптимизации backup - пропуск файлов, которые были backup'ed:
- Когда включена оптимизация
- ALL | LIKE option
- Один тип канала выделен
- Используется FRA
   
Как мы видим, команда crosscheck RMAN сравнивает записи каталога RMAN с фактическими файлами операционной системы и сообщает о местонахождении "истекших" или "устаревших" записей каталога RMAN.

# Лекиия 17

BACKUP AS [BACKUPSET | COPY]

## Создание backup sets
Формат файла:
- d - имя базы данных
- s - номер backup set
- p - номер куска backup set (piece)
- D - день месяца

Уровни инкрементального бекапа:
- 0: аналогичен полному бекапу
- 1: куммулятивный - только модифицированные после бекапа уровня 0, differential - блоки после последнего инкрементального бекапа.

Fast incremental backup - block change tracking - все блоки, которые изменены с последнего бекапа, сохранются в спец файл. - CTWR (v$block_change_tracking)

Read-only tablespace copy:
- Копия только, если ее нет
- Изменили формат доступа
- Можно использовать SKIP_READONLY

KEEP FOREVER (или до момента времени или точка востановления) - только реализуется в каталогах.

TAG - имя бекапа.

Шифрование - с помощью пароля и кошелька.
